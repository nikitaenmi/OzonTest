# Тестовое для OZON на позицию стажера SDET 
## Задача

### Легенда

В команду тестирования пришла задача: необходимо протестировать оплату зарубежных сервисов.
Запрос на оплату формируется пользователем на frontend и содержит наименование провайдера, сумму и дату.   
Cумма вводится в валюте получателя платежа, а итоговая сумма рассчитывается в рублях в зависимости от курса ЦБ.
Известно, что на текущий момент, нашей платёжной системе, запрещено выполнять платёж на сумму более 15000р.

### Суть задания

Необходимо реализовать мок-сервис имитирующий ответ от https://www.cbr.ru/scripts/XML_daily.asp?date_req=02/03/2002 и
обеспечивающий гибкость, воспроизводимость и надёжность тестов.

Подсказка: начать стоит с написания тесткейсов. 

### Особенности

- Микросервисная архитектура и асинхронное взаимодействие не допускают возможность пробрасывать какие либо параметры
  или заголовки для управления моком.
- Единый тестовый стенд с сотнями параллельно запускаемыми end-to-end тестами.


Будет плюсом:

- makefile/taskfile с командой для запуска
- наличие proto
- наличие swagger
- golang
- использование БД


## Результат
Разработан микросервис состоящий из основного API и мок-клиента, имитирующего ответы ЦБ РФ.

## Содержание
- [Архитектура](#архитектура)
- [Технологии](#технологии)
- [Быстрый старт](#быстрый-старт)
- [Проверка работы](#проверка-работы)
- [Описание переменнных окружения](#описание-переменных-окружения)
- [Обоснование реализации](#обоснование-реализации)


## Архитектура 
```bash
── cmd/
│   └── main.go                    - Точка входа приложения
├── internal/
│   ├── domain/
│   │   └── payment.go             - Доменные сущности
│   ├── server/
│   │   ├── handler/
│   │   │   ├── payment.go         - Хендлер POST
│   │   │   └── swagger.go         - Swagger
│   │   └── mapping.go             - Маппинг для хендлера 
│   ├── services/
│   │   ├── payment.go             - Бизнес-логика платежей
│   │   ├── conventor.go           - Конвертер валют (парсит XML ответ мок-клиента)
│   │   └── cbr_client.go          - Мок-клиент API ЦБ РФ
│   ├── repositories/
│   │   └── payment.go             - Репозиторный слой
│   ├── database/
│   │   ├── connection.go          - Подключение к БД
│   │   └── models/
│   │       └── models.go          - Модели базы данных и DTO репозиторного слоя
│   └── config/
│       └── config.go              - Конфиг
├── loadtest/
│   └── main.go                    - Нагрузочное тестирование
├── api/
│   └── payment.proto              - proto-файл
├── gen/
│   ├── payment.pb.go              - Сгенерированные структуры Protobuf
│   ├── payment_grpc.pb.go         
│   ├── payment.pb.gw.go           
│   └── payment.swagger.json       
├── third_party/                   - proto-файлы
│   ├── google/
│   │   └── api/
│   │       ├── annotations.proto  
│   │       └── http.proto         
│   └── protoc-gen-openapiv2/
│       └── options/
│           ├── annotations.proto  
│           └── openapiv2.proto    
├── migrations/
│   └── 001_init.sql               - Инициализация схемы и данных БД
├── samples/                       - Примеры файлов конфигурации
├── docker-compose.yml             - Конфигурация Docker
├── Makefile                       - Автоматизация задач
├── go.mod
└── go.sum
```


## Технологии
- Язык: Golang
- База данных: PostgreSQL
- API: gRPC-gateway
- ORM: GORM
- Логгер: Slog

## Быстрый старт

Клонируйте репозиторий и настройте .env:
```sh
git clone <https://github.com/nikitaenmi/OzonTest>
cd OzonTest
cp samples/.env.example .env
```
Вызовите make:
```sh
make start
```

## Проверка работы
```bash
curl -X POST http://localhost:8080/payments \
  -H "Content-Type: application/json" \
  -d '{"provider": "Ivan", "amount": 100, "date": "01/01/2023"}'
```
Ответ:
```bash
{
  "id": 1288,
  "provider": "Ivan",
  "amount": 100,
  "date": "01/01/2023"
}
```

## Результаты нагрузочного тестирования
Вызов нагрузочного тестирования:
```sh
cd ./loadtest  
go run main.go
```
Результат:
- Total requests: 1000   - всего запросов
- Successful: 1000       - успешных запросов
- Errors: 0              - неуспешных запросов
- Duration: 305ms        - время работы
- RPS: 3269.53

Request distribution:
- Amount exceeded: 200    - запросы превышающие 15000
- Invalid currency: 200   - запросы с невалидной валютой
- Negative amount: 200    - запросы с отрицательной суммой
- Valid alpha eur: 200    - валидный запрос (Альфа EUR)
- Valid tbank usd: 200    - валидный запрос (ТБанк USD)

## Описание переменных окружения
Переменные окружения:
- DB_HOST - хост PostgreSQL (по умолчанию: localhost)
- DB_PORT - порт PostgreSQL (по умолчанию: 5432)
- DB_USER - пользователь PostgreSQL (по умолчанию: root)
- DB_PASSWORD - пароль PostgreSQL (по умолчанию: root)
- DB_NAME - название базы данных (по умолчанию: database)
- DB_SSL_MODE - режим SSL (по умолчанию: disable)

- GRPC_PORT - порт для gRPC сервера (по умолчанию: :50051)
- HTTP_PORT - порт для HTTP gateway (по умолчанию: :8080)
- GRPC_TIMEOUT - таймаут для graceful shutdown (по умолчанию: 30s)

- CBR_TIMEOUT - таймаут для запросов к API ЦБ РФ в секундах (по умолчанию: 30)

- PAYMENT_MAX_AMOUNT_RUB - максимальная сумма платежа в рублях (по умолчанию: 15000)

- LOAD_TEST_REQUESTS - общее количество запросов (по умолчанию: 1000)
- LOAD_TEST_CONCURRENCY - количество параллельных запросов (по умолчанию: 50)
- LOAD_TEST_TIMEOUT - таймаут для тестирования (по умолчанию: 30s)
- LOAD_TEST_BASE_URL - базовый URL для тестирования (по умолчанию: http://localhost:8080/payments)

## Обоснование реализации

Было создано два сервиса, где основной  обрабатывает платежные запросы, а второй - мок-клиент имитирует работу API ЦБ. 

В проекте реализованы две таблицы PostgreSQL - одна хранит информацию о провайдерах и их валютах, другая данные о платежах. Процесс работы бизнес логики: валидация провайдера - запрос к мок-сервису ЦБ - парсинг ответа и конвертация валюты - проверка лимита - сохранение платежа.

Был реализован нагрузочный тест, отправляющий 1000 параллельных запросов с уникальными идентификаторами, что позволяет оценить производительность системы и корректность обработки данных.


### Особенности 
Переменные окружения:
- Чистая архитектура с разделением ответственностиc
- Нагрузочное тестирование с идентификацией запросов
- Стабильный мок-сервис
- Swagger


