# Тестовое для OZON на позицию стажера SDET 

## Содержание
- [Тестовое задание](#тестовое-задание)
- [Архитектура](#архитектура)
- [Запуск проекта](#запуск-проекта)
- [Проверка работы](#проверка-работы)
- [Описание задачи и реализации сервиса](#Описание-задачи-и-реализации-сервиса)
- [Описание переменнных окружения](#описание-переменных-окружения)
- [Обоснование реализации](#обоснование-реализации)

## Тестовое задание

### Легенда

- В команду тестирования пришла задача: необходимо протестировать оплату зарубежных сервисов.
Запрос на оплату формируется пользователем на frontend и содержит наименование провайдера, сумму и дату.   
- Cумма вводится в валюте получателя платежа, а итоговая сумма рассчитывается в рублях в зависимости от курса ЦБ.
- Известно, что на текущий момент, нашей платёжной системе, запрещено выполнять платёж на сумму более 15000р.

### Суть задания

Необходимо реализовать мок-сервис имитирующий ответ от https://www.cbr.ru/scripts/XML_daily.asp?date_req=02/03/2002 и
обеспечивающий гибкость, воспроизводимость и надёжность тестов.

Подсказка: начать стоит с написания тесткейсов. 

### Особенности

- Микросервисная архитектура и асинхронное взаимодействие не допускают возможность пробрасывать какие либо параметры
  или заголовки для управления моком.
- Единый тестовый стенд с сотнями параллельно запускаемыми end-to-end тестами.


Будет плюсом:

- makefile/taskfile с командой для запуска
- наличие proto
- наличие swagger
- golang
- использование БД


### Результат
Разработан микросервис состоящий из основного API и мок-клиента, имитирующего ответы ЦБ РФ.


## Архитектура 
```bash
── cmd/
│   └── main.go                    - Точка входа приложения
├── internal/
│   ├── domain/
│   │   └── payment.go             - Доменные сущности
│   ├── server/
│   │   ├── handler/
│   │   │   ├── payment.go         - Хендлер POST
│   │   │   └── swagger.go         - Swagger
│   │   └── mapping.go             - Маппинг для хендлера 
│   ├── services/
│   │   ├── payment.go             - Сервисный слой (бизнес-логика)
│   │   ├── conventor.go           - Конвертер валют (парсит XML ответ мок-клиента)
│   │   └── cbr_client.go          - Мок-клиент API ЦБ РФ
│   ├── repositories/
│   │   └── payment.go             - Репозиторный слой
│   ├── database/
│   │   ├── connection.go          - Подключение к БД
│   │   └── models/
│   │       └── models.go          - Модели базы данных и DTO репозиторного слоя
│   └── config/
│       └── config.go              - Конфиг
├── loadtest/
│   └── main.go                    - Нагрузочное тестирование
├── api/
│   └── payment.proto              - proto-файл
├── gen/
│   ├── payment.pb.go              - Сгенерированные структуры Protobuf
│   ├── payment_grpc.pb.go         
│   ├── payment.pb.gw.go           
│   └── payment.swagger.json       
├── third_party/                   - proto-файлы
│   ├── google/
│   │   └── api/
│   │       ├── annotations.proto  
│   │       └── http.proto         
│   └── protoc-gen-openapiv2/
│       └── options/
│           ├── annotations.proto  
│           └── openapiv2.proto    
├── migrations/
│   └── 001_init.sql               - Инициализация схемы БД
├── samples/.env.example           - Пример .env 
├── docker-compose.yml             - Конфигурация Docker
├── Makefile                       - Make-файл
├── go.mod
└── go.sum
```

### Технологии
- Язык: Golang
- База данных: PostgreSQL
- API: gRPC-gateway
- ORM: GORM
- Логгер: slog
- Документация: Swagger


## Запуск проекта
Клонируйте репозиторий и настройте .env:
```sh
git clone <https://github.com/nikitaenmi/OzonTest>
cd OzonTest
cp samples/.env.example .env
```
Вызовите make:
```sh
make start
```
```sh
make run
```


## Описание задачи и реализация сервиса
- Задача создать сервис, для тестирования оплаты. Тесты должны быть воспроизводимыми и надёжными, поэтому сервису нужно выдавать закономерные результаты

- Для решения данной задачи было принято решение сделать мок-сервис ЦБ РФ, выдающий значения курсов валют по специальной формуле. Эта формула выдаёт случайное, но определенное и воспроизводимое значение

- С frontend(а) приходит запрос на оплату, поэтому в проекте реализовано API с REST-like ручкой сгенерированной gRPC gateway. В этом же API происходит валидация платежа (к пр., по условию, платёж должен быть не более 15000 руб.)

### Описание работы сервиса
- API принимает данные о валюте и сумме с frontend(а) и вызывает мок-сервис ЦБ РФ

- Мок-сервис возращает ответ в формате XML - курсов валют к рублю, API парсит ответ, переводит сумму в рубли и валидирует

- Если всё успешно API делает запись в БД о платеже, и возращает сумму в рублях

- пользователь отправляет запрос ---> API вызывает мок-сервис ---> получает XML с курсами валют ---> API парсит XML и валидирует платёж ---> API возращает данные пользователю

### Дополнение
- В пункте ниже (Проверка работы), видно, как реализованы запросы frontend(а) и ответы сервиса

- В рамках сжатых сроков было принято решение не писать логику завязанную на провайдерах, а сохранять в БД информацию о площадке, на которой был совершен платёж

- Для проверки роботоспособоности приложения был реализан нагрузочный тест, вызывающий 1000 параллельных валидных и невалидных запросов (пункт ниже)

- API с frontend(а) принимает данные о дате, провайдере, валюте (USD, EUR и т.д.), сумме, а возращает то же самое, только сумму в рублях и ID платежа. Мок-сервис ЦБ РФ возращает XML


## Проверка работы и тестирование
### Тестовой запрос 
```bash
curl -X POST http://localhost:8080/payments \
  -H "Content-Type: application/json" \
  -d '{"provider": "Ivan", "amount": 100, "date": "01/01/2023", "currency": "USD"}'
```
Ответ:
```bash
{
  "id": 1,
  "provider": "Ivan",
  "amount": 9538,
  "date": "01/01/2023",
  "currency": "RUB",
}
```

### Результаты нагрузочного тестирования
Вызов нагрузочного тестирования:
```sh
cd ./loadtest  
go run main.go
```
Результат:
- Total requests: 1000   - всего запросов
- Successful: 1000       - успешных запросов
- Errors: 0              - неуспешных запросов
- Duration: 305ms        - время работы
- RPS: 3269.53

Request distribution:
- Amount exceeded: 200    - запросы превышающие 15000
- Invalid currency: 200   - запросы с невалидной валютой
- Negative amount: 200    - запросы с отрицательной суммой
- Valid alpha eur: 200    - валидный запрос (Альфа EUR)
- Valid tbank usd: 200    - валидный запрос (ТБанк USD)

### Swagger-документация
```sh
http://localhost:8080/docs
```


## Описание переменных окружения
- DB_HOST - хост PostgreSQL (по умолчанию: localhost)
- DB_PORT - порт PostgreSQL (по умолчанию: 5432)
- DB_USER - пользователь PostgreSQL (по умолчанию: root)
- DB_PASSWORD - пароль PostgreSQL (по умолчанию: root)
- DB_NAME - название базы данных (по умолчанию: database)
- DB_SSL_MODE - режим SSL (по умолчанию: disable)

- GRPC_PORT - порт для gRPC сервера (по умолчанию: :50051)
- HTTP_PORT - порт для HTTP gateway (по умолчанию: :8080)
- GRPC_TIMEOUT - таймаут для graceful shutdown (по умолчанию: 30s)

- CBR_TIMEOUT - таймаут для запросов к API ЦБ РФ в секундах (по умолчанию: 30)

- PAYMENT_MAX_AMOUNT_RUB - максимальная сумма платежа в рублях (по умолчанию: 15000)

- LOAD_TEST_REQUESTS - общее количество запросов (по умолчанию: 1000)
- LOAD_TEST_CONCURRENCY - количество параллельных запросов (по умолчанию: 50)
- LOAD_TEST_TIMEOUT - таймаут для тестирования (по умолчанию: 30s)
- LOAD_TEST_BASE_URL - базовый URL для тестирования (по умолчанию: http://localhost:8080/payments)

### Особенности 
- Чистая архитектура с разделением ответственноси
- Нагрузочное тестирование с идентификацией запросов
- Мок-сервис выдаёт воспроизводимые результаты
- gRPC-gateway генерирует rest-like интерфейс
- Swagger-документация


